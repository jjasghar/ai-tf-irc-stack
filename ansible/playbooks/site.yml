---
- name: Deploy IRC Stack (Ergo + The Lounge + Caddy)
  hosts: irc_servers
  become: true
  gather_facts: true
  vars:
    ergo_network: "{{ hostname.split('.')[0] | title }}"
    
  tasks:
    - name: Display deployment information
      debug:
        msg:
          - "Starting IRC stack deployment on {{ inventory_hostname }}"
          - "Hostname: {{ hostname }}"
          - "Cloud Provider: {{ cloud_provider }}"
          - "Debug Mode: {{ debug_mode }}"
          - "Operating System: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Network Name: {{ ergo_network }}"

    - name: Include OS-specific tasks
      include_tasks: "{{ ansible_distribution | lower }}.yml"
      
    - name: Ensure all services are running after configuration
      systemd:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - ergo
        - thelounge
        - caddy
      ignore_errors: true
      
    - name: Display completion message
      debug:
        msg:
          - "======================================"
          - "  üöÄ Installation Complete! ‚úÖ"
          - "======================================"
          - "Ergo IRC Server: Running on ports 6667 (plain) and 6697 (SSL)"
          - "The Lounge Web Client: Accessible via HTTPS only (secure!)" 
          - "Caddy Reverse Proxy: Running on ports 80 and 443"
          - "Web Interface: https://{{ hostname }}"
          - ""
          - "üîê SSL Certificate Status: AUTOMATIC & NON-BLOCKING"
          - "  ‚úÖ Certificates are being acquired in the background"
          - "  ‚úÖ System is production-ready immediately"
          - "  ‚úÖ No manual intervention required!"
          - "  ‚úÖ Automatic retry every 5 minutes until successful"
          - ""
          - "üéØ TRUE ONE-COMMAND AUTOMATION ACHIEVED!"
          - "To check service status, run: /root/check_services.sh"
          - "======================================"